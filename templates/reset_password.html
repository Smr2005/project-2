{% extends "base.html" %}

{% block title %}Reset Access Key - QueryVault{% endblock %}

{% block content %}
<section class="connection-box" style="max-width: 450px; margin: 6rem auto;" data-aos="zoom-in">
    <h2 class="section-title" style="font-size: 1.8rem; margin-bottom: 2rem;">New Access Key</h2>
    
    <form id="reset-form">
        <input type="hidden" id="token" value="{{ token }}">
        <div class="input-group">
            <label for="password">New Access Key (Password)</label>
            <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="8">
        </div>

        <div class="input-group" style="margin-top: 1.5rem;">
            <label for="confirm-password">Confirm Access Key</label>
            <input type="password" id="confirm-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required minlength="8">
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <span class="btn-icon">ðŸ”§</span> Re-initialize Identity
            </button>
        </div>
    </form>

    <div id="status-msg" class="message-container info hidden" style="margin-top: 1.5rem;"></div>

    <p style="margin-top: 2rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
        <a href="/login" style="color: var(--primary-blue); font-weight: bold; text-decoration: none;">Return to Login</a>
    </p>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('reset-form').onsubmit = async (e) => {
        e.preventDefault();
        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm-password').value;
        const token = document.getElementById('token').value;
        const msg = document.getElementById('status-msg');

        if (password !== confirm) {
            msg.textContent = 'Neural mismatch: Passwords do not match.';
            msg.className = "message-container error";
            msg.classList.remove('hidden');
            return;
        }

        try {
            const resp = await fetch('/auth/reset-password', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, password })
            });
            const data = await resp.json();
            
            if (resp.ok) {
                msg.textContent = data.message;
                msg.className = "message-container info";
                setTimeout(() => window.location.href = '/login', 3000);
            } else {
                msg.textContent = data.detail || 'Reset failed.';
                msg.className = "message-container error";
            }
            msg.classList.remove('hidden');
        } catch (err) {
            msg.textContent = 'Connection Error: Secure channel failed.';
            msg.className = "message-container error";
            msg.classList.remove('hidden');
        }
    };
</script>
{% endblock %}
