{% extends "base.html" %}

{% block title %}Register - New Agent Identity{% endblock %}

{% block content %}
<section class="connection-box" style="max-width: 450px; margin: 6rem auto;" data-aos="zoom-in">
    <h2 class="section-title" style="font-size: 1.8rem; margin-bottom: 2rem;">Identity Registration</h2>
    
    <div id="auth-error" class="message-container error hidden" style="margin-bottom: 1.5rem;"></div>
    <div id="auth-success" class="message-container info hidden" style="margin-bottom: 1.5rem;"></div>

    <form id="register-form">
        <div class="input-group">
            <label for="fullname">Full Name</label>
            <input type="text" id="fullname" name="fullname" placeholder="John Doe" required>
        </div>

        <div class="input-group" style="margin-top: 1.5rem;">
            <label for="email">Neural Identity (Email)</label>
            <input type="email" id="email" name="email" placeholder="agent@queryvault.io" required>
        </div>
        
        <div class="input-group" style="margin-top: 1.5rem;">
            <label for="password">Access Key (Password)</label>
            <input type="password" id="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>

        <div class="input-group" style="margin-top: 1.5rem;">
            <label for="confirm-password">Confirm Access Key</label>
            <input type="password" id="confirm-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
        </div>

        <div style="margin-top: 2rem;">
            <button type="submit" class="btn btn-primary" style="width: 100%;">
                <span class="btn-icon">üõ°Ô∏è</span> Register Identity
            </button>
        </div>
    </form>

    <p style="margin-top: 2rem; text-align: center; color: var(--text-secondary); font-size: 0.9rem;">
        Already registered? <a href="/login" style="color: var(--primary-blue); font-weight: bold; text-decoration: none;">Initialize Session</a>
    </p>
</section>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('register-form').onsubmit = async (e) => {
        e.preventDefault();
        const fullname = document.getElementById('fullname').value;
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const confirm = document.getElementById('confirm-password').value;
        const errorEl = document.getElementById('auth-error');
        const successEl = document.getElementById('auth-success');

        if (password !== confirm) {
            errorEl.textContent = 'Error: Access keys do not match';
            errorEl.classList.remove('hidden');
            return;
        }

        try {
            const resp = await fetch('/auth/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, full_name: fullname })
            });

            if (resp.ok) {
                successEl.textContent = 'Registration Successful! Redirecting to login...';
                successEl.classList.remove('hidden');
                errorEl.classList.add('hidden');
                setTimeout(() => window.location.href = '/login', 2000);
            } else {
                const data = await resp.json();
                errorEl.textContent = data.detail || 'Registration Failed: Identity already exists';
                errorEl.classList.remove('hidden');
            }
        } catch (err) {
            errorEl.textContent = 'Connection Error: Registration uplink failed';
            errorEl.classList.remove('hidden');
        }
    };
</script>
{% endblock %}
